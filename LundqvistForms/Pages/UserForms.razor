@page "/forms"

@using FormsLibrary.Models;
@using LundqvistForms.Components;
@using LundqvistForms.Services;
@inject FormServiceUi formService
@inject NavigationManager navigationManager;
@inject IDialogService DialogService;
@inject ISnackbar Snackbar

<MudPaper Class="mx-16 pa-10 mb-16">
    @if (forms == null)
    {
        <MudText Typo="Typo.h2">Laddar...</MudText>
    }
    else if (forms.Count == 0)
    {
        <MudText Typo="Typo.h2">Du har inga formulär just nu</MudText>
    }
    else
    {
        <MudText Typo="Typo.h2" Class="mb-4">Dina formulär</MudText>
        <MudTable Items="forms" GroupHeaderStyle="@($"background-color: {Colors.Grey.Darken1}")" CustomHeader Hover="true" LoadingProgressColor="Color.Warning" Class="mx-12 pa-4" Style="@($"background-color: {Colors.Grey.Darken2}")">
            <HeaderContent>
                <MudTh>Titel</MudTh>
                <MudTh>Antal frågor</MudTh>
                <MudTh Style="width: 200px"></MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Title">@context.FormTitle</MudTd>
                <MudTd DataLabel="Antal frågor">@CountQuestion(context)</MudTd>
                <MudTd DataLabel="" Class="d-flex justify-end gap-2">
                    <MudTooltip Text="Förhandsgranska" Style="@($"background-color: {Colors.Grey.Darken3}")" Arrow="true" Placement="Placement.Bottom">
                        <MudIconButton Icon="@Icons.Material.Filled.RemoveRedEye" Variant="Variant.Outlined" OnClick="@(() => GoToPreview(context))" Color="Color.Warning"></MudIconButton>
                    </MudTooltip>
                    <MudTooltip Text="Regidera" Style="@($"background-color: {Colors.Grey.Darken3}")" Arrow="true" Placement="Placement.Bottom">
                        <MudIconButton Icon="@Icons.Material.Filled.Edit" Variant="Variant.Filled" OnClick="@(() => EditForm(context))" Color="Color.Warning"></MudIconButton>
                    </MudTooltip>
                    <MudTooltip Text="Ta bort" Style="@($"background-color: {Colors.Grey.Darken3}")" Arrow="true" Placement="Placement.Bottom">
                        <MudIconButton Icon="@Icons.Material.Filled.DeleteForever" Variant="Variant.Filled" OnClick="@(() => DeleteForm(context))" Color="Color.Error"></MudIconButton>
                    </MudTooltip>
                </MudTd>
            </RowTemplate>
        </MudTable>
    }
</MudPaper>

<MudMessageBox @ref="deleteFormBox" Title="Ta bort formulär" CancelText="Avbryt">
    <MessageContent>
        Är du säker att du vill ta bort formuläret?
    </MessageContent>
    <YesButton>
        <MudButton Variant="Variant.Filled" Color="Color.Error">Ta bort</MudButton>
    </YesButton>
</MudMessageBox>


@code {
    // TODO: Kolla table filtrering med mera
    // TODO: Fixa sortering på användares formulär på UserForms

    public List<FormModel>? forms = null;
    private MudMessageBox? deleteFormBox { get; set; }
    private string deleteFormMessage = "Formulär borttaget";

    protected override async Task OnInitializedAsync()
    {
        forms = await formService.GetAllForms();
    }

    private int CountQuestion(FormModel form)
    {
        var count = 0;

        foreach (SegmentModel segment in form.Segments.ToList())
        {
            count += segment.Questions.Count;
        }

        return count;
    }

    public void Update()
    {
        this.StateHasChanged();
    }

    private void GoToPreview(FormModel form)
    {

    }

    private void EditForm(FormModel form)
    {
        navigationManager.NavigateTo($"/forms/edit/{form.FormId}");
    }

    private async void DeleteForm(FormModel form)
    {
        bool? result = await deleteFormBox.Show();

        if (result == null || result == false)
        {
            return;
        }

        await formService.DeleteForm(form);
        forms = await formService.GetAllForms();
        Snackbar.Add(deleteFormMessage, Severity.Info);

        StateHasChanged();
    }
}
