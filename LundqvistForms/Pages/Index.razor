@page "/"

@using FormsLibrary.Models;
@using LundqvistForms.Components;
@using LundqvistForms.Services;
@inject FormServiceUi formService;
@inject SegmentServiceUi segmentService;
@inject QuestionServiceUi questionService;

<PageTitle>Lundqvist Forms</PageTitle>

<MudPaper Width="100%" Class="d-flex flex-column align-center gap-2 pb-4" Elevation="0" Style="@($"background-color: {Colors.Grey.Darken4};")">
    <FormHeader Form="@Form" />

    <Virtualize Items="Form.Segments" Context="segment">
        <MudContainer Class="d-flex gap-2 mx-0 justify-center">
            <MudContainer MaxWidth="MaxWidth.Medium" @onclick="@(() => FocusSegment(segment))" Class="d-flex flex-column gap-2 rounded-3 pa-4 ma-0 rounded" Style="@($"background-color: {Colors.Grey.Darken3}; border-left: 4px solid {CheckFocus(segment)};")">
                <SegmentHeader IsFocused="@(currentSegment == segment)" Segment="segment" />
                <Questions Segment="@segment" />
            </MudContainer>

            @if (segment == currentSegment)
            {
                <Controls OnQuestionAdded="AddQuestion" OnSegmentAdded="AddSegment" />
            }
        </MudContainer>
    </Virtualize>

    <MudContainer Class="d-flex justify-center gap-2">
        <MudTooltip Arrow="true" Placement="Placement.Right">
            <MudButton Variant="Variant.Filled" Color="Color.Warning" OnClick="CreateForm" StartIcon="@Icons.Material.Filled.AddCircle" Size="Size.Large">Skapa formulär</MudButton>
        </MudTooltip>

        <MudTooltip Arrow="true" Placement="Placement.Right">
            <MudButton Variant="Variant.Outlined" Color="Color.Warning" OnClick="ClearForm" StartIcon="@Icons.Material.Filled.Delete" Size="Size.Large">Rensa formulär</MudButton>
        </MudTooltip>
    </MudContainer>
</MudPaper>

@code {
    // TODO: Flytta controls knapparna så att dom följer med aktiva avstnittet med animation
    // TODO: Fixa vid focus av dropdowns att texten i fälten blir på samma ställe som dropdown
    // TODO: Fixa så att hela formen sparas ifall man skulle refresha sidan
    // TODO: Kunna radera på alla steg. Enskild fråga, enskilt avsnitt och hela formuläret
    // TODO: Fixa expand och collapse på avsnitt
    // TODO: Fixa are you sure på radera knappar
    // TODO: Fixa global ångra knapp, och ctrl y liknande knapp
    // TODO: Lägg till date now vid create list i API
    [Parameter]
    public FormModel Form { get; set; } = new();
    private SegmentModel currentSegment = new();

    protected override async Task OnInitializedAsync()
    {
        Form.FormTitle = "Formulär utan namn";
        Form.FormDescription = "Ingen beskrivning";
        AddSegment();
    }

    public void AddQuestion()
    {
        QuestionModel newQuestion = new()
            {
                SegmentId = currentSegment.SegmentId
            };
        currentSegment.Questions.Add(newQuestion);
    }

    public void AddSegment()
    {
        SegmentModel newSegment = new()
            {
                FormId = Form.FormId,
                SegmentTitle = "Avsnitt utan namn",
                SegmentDescription = "Ingen beskrivning"
            };
        Form.Segments.Add(newSegment);
        currentSegment = newSegment;
    }

    public void FocusSegment(SegmentModel segment)
    {
        currentSegment = segment;
    }

    public string CheckFocus(SegmentModel segment)
    {
        if (currentSegment == segment)
        {
            return Colors.Grey.Lighten5;
        }
        return Colors.Grey.Darken3;
    }

    public async Task CreateForm()
    {
        try
        {
            await formService.CreateForm(Form);
            Form = new()
                {
                    FormTitle = "Formulär utan namn",
                    FormDescription = "Ingen beskrivning"
                };
            AddSegment();
        }
        catch (Exception)
        {

            return;
        }

    }

    public void ClearForm()
    {
        Form = new();
        Form.FormTitle = "Formulär utan namn";
        Form.FormDescription = "Ingen beskrivning";

        AddSegment();
    }
}