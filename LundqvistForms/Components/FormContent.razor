@using FormsLibrary.Models;

<FormHeader FormType="@FormType" Form="Form" />

<Virtualize Items="Form.Segments" Context="segment">
    <MudContainer Class="d-flex gap-2 mx-0 justify-center">
        <MudContainer MaxWidth="MaxWidth.Medium"
                      @onclick="@(() => FocusSegment(segment))"
                      Class="d-flex flex-column gap-2 rounded-3 pa-4 ma-0 rounded"
                      Style="@($"background-color: {Colors.Grey.Darken3}; border-left: 4px solid {CheckFocus(segment)};")">
            <SegmentHeader OnToggleExpand="@(() => ToggleSegmentExpand(segment))"
                           OnChange="Update"
                           Form="Form"
                           IsFocused="@(currentSegment == segment)" Segment="segment" />
            <Questions FormType="@FormType" Form="Form" OnChange="Update" Segment="segment" Expanded="segmentExpanded" />
        </MudContainer>

        @if (segment == currentSegment)
        {
            <Controls OnQuestionAdded="AddQuestion" OnSegmentAdded="AddSegment" />
        }
    </MudContainer>
</Virtualize>

@code {
    [Parameter]
    public EventCallback<FormModel> OnChange { get; set; }

    [Parameter]
    public FormModel Form { get; set; }

    [Parameter]
    public string FormType { get; set; }

    [Parameter]
    public int FormId { get; set; }

    private bool segmentExpanded = true;
    private SegmentModel currentSegment = new();

    protected override async Task OnParametersSetAsync()
    {
        if (Form.FormTitle != "")
        {
            currentSegment = Form.Segments.ToList()[0];
        }
    }

    public async void AddQuestion()
    {
        QuestionModel newQuestion = new()
            {
                SegmentId = currentSegment.SegmentId,
                QuestionTitle = $"Fråga {currentSegment.Questions.Count + 1}"
            };

        ChoiceModel newChoice = new()
            {
                QuestionId = newQuestion.QuestionId,
                ChoiceTitle = "Alternativ 1"
            };
        newQuestion.ChoiceOptions.Add(newChoice);

        currentSegment.Questions.Add(newQuestion);
        await OnChange.InvokeAsync();

    }

    public async void AddSegment()
    {
        SegmentModel newSegment = new()
            {
                FormId = Form.FormId,
                SegmentTitle = "Avsnitt utan namn",
                SegmentDescription = "Ingen beskrivning"
            };
        Form.Segments.Add(newSegment);
        currentSegment = newSegment;

        await OnChange.InvokeAsync();
    }

    public void FocusSegment(SegmentModel segment)
    {
        currentSegment = segment;
    }

    public string CheckFocus(SegmentModel segment)
    {
        if (currentSegment == segment)
        {
            return Colors.Grey.Lighten5;
        }
        return Colors.Grey.Darken3;
    }

    public void ToggleSegmentExpand(SegmentModel segment)
    {
        currentSegment = segment;
        segmentExpanded = !segmentExpanded;
    }

    private async void Update()
    {
        StateHasChanged();
        await OnChange.InvokeAsync();
    }
}
